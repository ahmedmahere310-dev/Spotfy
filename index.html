<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <script src="script.js"></script>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>مكتبتي الموسيقية ULTIMATE - كلمات ذكية</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jsmediatags/3.9.5/jsmediatags.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Cairo:wght@300;400;700&display=swap');
        body { font-family: 'Cairo', sans-serif; background-color: #000; color: white; user-select: none; }
        .active-link { color: #1db954; border-right: 4px solid #1db954; background: rgba(29, 185, 84, 0.1); }
        .song-card:hover .play-btn { opacity: 1; transform: translateY(0); }
        #fullPlayer { transition: transform 0.5s cubic-bezier(0.32, 0.72, 0, 1); transform: translateY(100%); }
        #fullPlayer.open { transform: translateY(0); }
        .no-scrollbar::-webkit-scrollbar { display: none; }
        input[type="range"] { -webkit-appearance: none; background: #333; height: 4px; border-radius: 2px; }
        input[type="range"]::-webkit-slider-thumb { -webkit-appearance: none; height: 12px; width: 12px; border-radius: 50%; background: #1db954; cursor: pointer; }
        .shuffle-active { color: #1db954; filter: drop-shadow(0 0 5px #1db954); }
        .lyrics-container { mask-image: linear-gradient(to bottom, transparent, black 15%, black 85%, transparent); }
        .lyric-line { transition: all 0.4s ease; }
        .lyric-line:hover { transform: scale(1.05); color: white; }
    </style>
</head>
<body class="h-screen flex flex-col overflow-hidden bg-black">

    <div class="flex flex-1 overflow-hidden">
        <!-- Sidebar -->
        <aside class="w-72 bg-black flex flex-col border-l border-gray-900 hidden md:flex">
            <div class="p-6 text-2xl font-bold text-green-500 flex items-center gap-2">
                <div class="bg-green-500 text-black p-1 rounded-md">
                    <svg class="h-6 w-6" fill="currentColor" viewBox="0 0 24 24"><path d="M12 3v10.55c-.59-.34-1.27-.55-2-.55-2.21 0-4 1.79-4 4s1.79 4 4 4 4-1.79 4-4V7h4V3h-6z"/></svg>
                </div>
                مكتبتي PRO
            </div>
            
            <nav class="flex flex-col px-2 gap-1">
                <!-- زر الشاشة الرئيسية الصريح -->
                <button id="homeNavBtn" onclick="showSection('home')" class="nav-btn flex items-center gap-4 p-3 hover:bg-white/5 rounded-lg transition active-link">
                    <svg class="h-5 w-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-width="2" d="M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-11l2 2m-2-2v10a1 1 0 01-1 1h-3m-6 0a1 1 0 001-1v-4a1 1 0 011-1h2a1 1 0 011 1v4a1 1 0 001 1m-6 0h6"/></svg>
                    <span class="font-bold">الشاشة الرئيسية</span>
                </button>
                <button onclick="showSection('artists')" class="nav-btn flex items-center gap-4 p-3 hover:bg-white/5 rounded-lg transition">
                    <svg class="h-5 w-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"/></svg>
                    <span>الفنانين</span>
                </button>
                <button onclick="showSection('favorites')" class="nav-btn flex items-center gap-4 p-3 hover:bg-white/5 rounded-lg transition">
                    <svg class="h-5 w-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-width="2" d="M4.318 6.318a4.5 4.5 0 000 6.364L12 20.364l7.682-7.682a4.5 4.5 0 00-6.364-6.364L12 7.636l-1.318-1.318a4.5 4.5 0 00-6.364 0z"/></svg>
                    <span>المفضلة</span>
                </button>
                <button onclick="downloadAllSongs()" class="flex items-center gap-4 p-3 hover:bg-white/5 rounded-lg transition text-green-400 group">
                    <svg class="h-5 w-5 group-hover:bounce" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"/></svg>
                    <span class="text-sm font-bold">تحميل المكتبة كاملة</span>
                </button>
            </nav>

            <div class="mt-8 px-4 flex-1 overflow-hidden flex flex-col border-t border-gray-900 pt-4">
                <div class="flex items-center justify-between mb-4">
                    <span class="text-xs font-bold text-gray-500 uppercase tracking-widest font-bold">قوائمك</span>
                    <button onclick="openInputModal()" class="text-gray-400 hover:text-white"><svg class="h-5 w-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-width="2" d="M12 4v16m8-8H4"/></svg></button>
                </div>
                <div id="playlistsList" class="flex flex-col gap-1 overflow-y-auto no-scrollbar"></div>
            </div>

            <div class="p-4 border-t border-gray-900 flex flex-col gap-2">
                <button onclick="toggleFullScreen()" class="w-full bg-gray-800 text-white font-bold py-2 px-4 rounded-xl flex items-center justify-center gap-2 transition hover:bg-gray-700 text-xs">
                    <svg class="h-4 w-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-width="2" d="M4 8V4m0 0h4M4 4l5 5m11-1V4m0 0h-4m4 0l-5 5"/></svg>
                    ملئ الشاشة
                </button>
                <label class="cursor-pointer bg-white text-black font-bold py-3 px-4 rounded-xl flex items-center justify-center gap-2 transition hover:scale-[1.02]">
                    <input type="file" id="fileInput" multiple accept="audio/*" class="hidden" onchange="handleUpload(event)">
                    <span class="text-sm">إضافة أغاني</span>
                </label>
            </div>
        </aside>

        <!-- Main Content -->
        <main class="flex-1 flex flex-col overflow-hidden bg-gradient-to-b from-[#1a1a1a] to-black">
            <header class="p-6 flex items-center justify-between">
                <div class="relative w-full max-w-md">
                    <input type="text" id="searchInput" placeholder="بحث باسم الأغنية أو الفنان..." 
                           class="w-full bg-[#2a2a2a] rounded-full py-2 px-10 focus:outline-none focus:ring-1 focus:ring-gray-500 text-right text-sm"
                           oninput="handleSearch()">
                    <svg class="h-4 w-4 absolute right-4 top-3 text-gray-500" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"/></svg>
                </div>
                <!-- زر الشاشة الرئيسية للهواتف -->
                <button onclick="showSection('home')" class="md:hidden p-2 bg-white/5 rounded-full"><svg class="h-6 w-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-width="2" d="M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-11l2 2m-2-2v10a1 1 0 01-1 1h-3m-6 0a1 1 0 001-1v-4a1 1 0 011-1h2a1 1 0 011 1v4a1 1 0 001 1m-6 0h6"/></svg></button>
            </header>

            <div id="content-display" class="p-6 overflow-y-auto flex-1 no-scrollbar">
                <section id="home-section">
                    <h2 class="text-2xl font-bold mb-6 flex justify-between items-center" id="mainTitle"><span>الأغاني</span></h2>
                    <div id="songsGrid" class="grid grid-cols-2 sm:grid-cols-3 lg:grid-cols-4 xl:grid-cols-5 gap-6"></div>
                </section>
                <section id="artists-section" class="hidden">
                    <h2 class="text-2xl font-bold mb-6">الفنانين</h2>
                    <div id="artistsGrid" class="grid grid-cols-2 sm:grid-cols-3 lg:grid-cols-5 gap-6"></div>
                </section>
            </div>
        </main>
    </div>

    <!-- Mini Player -->
    <footer id="miniPlayer" class="h-20 bg-black/95 border-t border-gray-900 px-4 flex items-center justify-between z-50 cursor-pointer" onclick="openFullPlayer()">
        <div class="flex items-center gap-3 w-1/3 overflow-hidden">
            <img id="player-img" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAQAAAC1HAwCAAAAC0lEQVR42mNkYAAAAAYAAjCB0C8AAAAASUVORK5CYII=" class="h-12 w-12 rounded object-cover">
            <div class="overflow-hidden">
                <div id="player-title" class="font-bold truncate text-sm">--</div>
                <div id="player-artist" class="text-xs text-gray-500 truncate">--</div>
            </div>
            <button onclick="event.stopPropagation(); toggleCurrentFavorite()" class="ml-2">
                <svg id="heartIcon" class="h-5 w-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-width="2" d="M4.318 6.318a4.5 4.5 0 000 6.364L12 20.364l7.682-7.682a4.5 4.5 0 00-6.364-6.364L12 7.636l-1.318-1.318a4.5 4.5 0 00-6.364 0z"/></svg>
            </button>
        </div>

        <div class="flex flex-col items-center gap-1 w-1/3 hidden md:flex" onclick="event.stopPropagation()">
            <div class="flex items-center gap-6">
                <button onclick="toggleShuffle()" id="shuffleBtn" class="text-gray-500 hover:text-white transition"><svg class="h-4 w-4" fill="currentColor" viewBox="0 0 24 24"><path d="M10.59 9.17L5.41 4 4 5.41l5.17 5.17 1.42-1.41zM14.5 4l2.04 2.04L4 18.59 5.41 20 17.96 7.45 20 9.5V4h-5.5zm.33 9.41l-1.41 1.41 3.13 3.13L14.5 20H20v-5.5l-2.04 2.04-3.13-3.13z"/></svg></button>
                <button onclick="prevTrack()" class="text-gray-300 hover:text-white"><svg class="h-6 w-6" fill="currentColor" viewBox="0 0 24 24"><path d="M6 6h2v12H6zm3.5 6l8.5 6V6z"/></svg></button>
                <button onclick="togglePlay()" class="bg-white text-black p-2 rounded-full hover:scale-110 transition">
                    <svg id="playIconMini" class="h-6 w-6" fill="currentColor" viewBox="0 0 24 24"><path d="M8 5v14l11-7z"/></svg>
                    <svg id="pauseIconMini" class="h-6 w-6 hidden" fill="currentColor" viewBox="0 0 24 24"><path d="M6 19h4V5H6v14zm8-14v14h4V5h-4z"/></svg>
                </button>
                <button onclick="nextTrack()" class="text-gray-300 hover:text-white"><svg class="h-6 w-6" fill="currentColor" viewBox="0 0 24 24"><path d="M6 18l8.5-6L6 6v12zM16 6v12h2V6h-2z"/></svg></button>
            </div>
            <div class="flex items-center gap-2 w-full max-sm px-4">
                <span id="currentTime" class="text-[10px] text-gray-500">0:00</span>
                <input type="range" id="progressBar" value="0" class="flex-1 accent-white" oninput="seek()">
                <span id="durationTime" class="text-[10px] text-gray-500">0:00</span>
            </div>
        </div>

        <div class="flex items-center justify-end gap-3 w-1/3 hidden md:flex" onclick="event.stopPropagation()">
             <button onclick="downloadSingleSong(currentSong)" class="text-gray-500 hover:text-white mr-4"><svg class="h-5 w-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"/></svg></button>
             <input type="range" class="w-20 accent-white" value="80" oninput="audio.volume = this.value / 100">
        </div>
    </footer>

    <!-- Full Player Overlay -->
    <div id="fullPlayer" class="fixed inset-0 z-[100] bg-black flex flex-col lg:flex-row p-6 overflow-hidden">
        <div id="fullBg" class="absolute inset-0 opacity-30 blur-[100px] transition-all duration-1000 pointer-events-none" style="background-size: cover;"></div>
        
        <!-- Left Side: Cover & Controls -->
        <div class="relative z-10 flex-1 flex flex-col items-center justify-center gap-6 lg:w-1/2">
            <header class="absolute top-0 w-full flex justify-between items-center p-4">
                <button onclick="closeFullPlayer()" class="p-2 bg-white/5 rounded-full hover:bg-white/10 transition"><svg class="h-6 w-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-width="2" d="M19 9l-7 7-7-7"/></svg></button>
                <button onclick="showSection('home'); closeFullPlayer();" class="text-xs bg-white/10 px-4 py-1 rounded-full font-bold">الرئيسية</button>
                <button onclick="openSongOptions(currentSong)" class="p-2 bg-white/5 rounded-full hover:bg-white/10 transition"><svg class="h-6 w-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-width="2" d="M12 5v.01M12 12v.01M12 19v.01M12 6a1 1 0 110-2 1 1 0 010 2zm0 7a1 1 0 110-2 1 1 0 010 2zm0 7a1 1 0 110-2 1 1 0 010 2z"/></svg></button>
            </header>

            <img id="fullCover" src="" class="w-full max-w-[320px] aspect-square object-cover rounded-2xl shadow-2xl transition-all duration-500">
            
            <div class="w-full max-w-sm flex justify-between items-center">
                <div class="text-right flex-1 px-4 overflow-hidden">
                    <h2 id="fullTitle" class="text-2xl font-bold truncate">--</h2>
                    <p id="fullArtist" class="text-lg text-gray-400 truncate">--</p>
                </div>
                <button onclick="toggleCurrentFavorite()"><svg id="fullHeartIcon" class="h-7 w-7" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-width="2" d="M4.318 6.318a4.5 4.5 0 000 6.364L12 20.364l7.682-7.682a4.5 4.5 0 00-6.364-6.364L12 7.636l-1.318-1.318a4.5 4.5 0 00-6.364 0z"/></svg></button>
            </div>

            <div class="w-full max-w-sm px-4">
                <input type="range" id="fullProgressBar" value="0" class="w-full accent-white" oninput="seekFull()">
                <div class="flex justify-between text-[10px] text-gray-500 mt-2">
                    <span id="fullCurrentTime">0:00</span>
                    <span id="fullDurationTime">0:00</span>
                </div>
            </div>

            <div class="w-full max-w-sm flex justify-between items-center px-4">
                <button onclick="toggleShuffle()" id="fullShuffleBtn" class="text-gray-500 transition"><svg class="h-5 w-5" fill="currentColor" viewBox="0 0 24 24"><path d="M10.59 9.17L5.41 4 4 5.41l5.17 5.17 1.42-1.41zM14.5 4l2.04 2.04L4 18.59 5.41 20 17.96 7.45 20 9.5V4h-5.5zm.33 9.41l-1.41 1.41 3.13 3.13L14.5 20H20v-5.5l-2.04 2.04-3.13-3.13z"/></svg></button>
                <button onclick="prevTrack()" class="text-white"><svg class="h-8 w-8" fill="currentColor" viewBox="0 0 24 24"><path d="M6 6h2v12H6zm3.5 6l8.5 6V6z"/></svg></button>
                <button onclick="togglePlay()" class="bg-white text-black p-4 rounded-full scale-110 shadow-lg transition hover:scale-125">
                    <svg id="fullPlayIcon" class="h-8 w-8" fill="currentColor" viewBox="0 0 24 24"><path d="M8 5v14l11-7z"/></svg>
                    <svg id="fullPauseIcon" class="h-8 w-8 hidden" fill="currentColor" viewBox="0 0 24 24"><path d="M6 19h4V5H6v14zm8-14v14h4V5h-4z"/></svg>
                </button>
                <button onclick="nextTrack()" class="text-white"><svg class="h-8 w-8" fill="currentColor" viewBox="0 0 24 24"><path d="M6 18l8.5-6L6 6v12zM16 6v12h2V6h-2z"/></svg></button>
                <button id="repeatBtn" onclick="toggleRepeat()" class="text-gray-500 transition"><svg class="h-5 w-5" fill="currentColor" viewBox="0 0 24 24"><path d="M7 7h10v3l4-4-4-4v3H5v6h2V7zm10 10H7v-3l-4 4 4 4v-3h12v-6h-2v4z"/></svg></button>
            </div>
        </div>

        <!-- Right Side: Smart Lyrics Section -->
        <div class="relative z-10 flex-1 flex flex-col p-6 lg:w-1/2 mt-10 lg:mt-0 border-r border-white/5 bg-black/20 backdrop-blur-md lg:rounded-l-3xl">
            <div class="flex items-center justify-between mb-8">
                <div>
                    <h3 class="text-2xl font-bold text-white">الكلمات</h3>
                    <p id="lyricsStatus" class="text-[10px] text-green-500 mt-1 hidden">تم البحث بنجاح ✓</p>
                </div>
                <div class="flex gap-2">
                    <button onclick="fetchLyricsOnline()" id="searchLyricsBtn" class="text-xs bg-green-600/20 text-green-400 px-4 py-2 rounded-full hover:bg-green-600/40 transition flex items-center gap-2">
                         <svg class="h-3 w-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"/></svg>
                         بحث أونلاين
                    </button>
                    <button onclick="openLyricsEditor()" class="text-xs bg-white/10 px-4 py-2 rounded-full hover:bg-white/20 transition">تعديل يدوي</button>
                </div>
            </div>
            <div id="lyricsDisplay" class="flex-1 overflow-y-auto no-scrollbar lyrics-container text-right pb-32">
                <div class="text-xl text-gray-600 italic mt-20 opacity-50 leading-relaxed">جاري انتظار تشغيل الأغنية...</div>
            </div>
        </div>
    </div>

    <!-- Lyrics Editor Modal -->
    <div id="lyricsModal" class="fixed inset-0 z-[200] bg-black/95 hidden flex items-center justify-center p-6">
        <div class="bg-[#1a1a1a] w-full max-w-2xl rounded-2xl p-6 border border-gray-800 flex flex-col h-[70vh]">
            <h3 class="text-lg font-bold mb-4">تعديل كلمات الأغنية</h3>
            <textarea id="lyricsInput" class="flex-1 bg-[#2a2a2a] p-4 rounded-xl mb-6 focus:outline-none text-right resize-none no-scrollbar leading-relaxed text-lg" placeholder="ضع كلمات الأغنية هنا..."></textarea>
            <div class="flex gap-3">
                <button onclick="closeLyricsModal()" class="flex-1 p-3 rounded-xl bg-gray-800 transition">إلغاء</button>
                <button onclick="saveLyrics()" class="flex-1 p-3 rounded-xl bg-green-500 text-black font-bold">حفظ الكلمات</button>
            </div>
        </div>
    </div>

    <div id="uiModal" class="fixed inset-0 z-[200] bg-black/90 hidden flex items-center justify-center p-6">
        <div class="bg-[#1a1a1a] w-full max-w-sm rounded-2xl p-6 border border-gray-800 text-center">
            <h3 id="modalTitle" class="text-lg font-bold mb-4">إنشاء قائمة تشغيل</h3>
            <input type="text" id="modalInput" class="w-full bg-[#2a2a2a] p-3 rounded-xl mb-6 focus:outline-none text-center" placeholder="اسم القائمة">
            <div class="flex gap-3">
                <button onclick="closeUIModal()" class="flex-1 p-3 rounded-xl bg-gray-800 transition">إلغاء</button>
                <button id="modalAction" class="flex-1 p-3 rounded-xl bg-green-500 text-black font-bold">تأكيد</button>
            </div>
        </div>
    </div>

    <div id="optionsModal" class="fixed inset-0 z-[200] bg-black/95 hidden flex items-end justify-center">
        <div class="bg-[#1a1a1a] w-full max-w-md rounded-t-3xl p-6 border-t border-gray-800 shadow-[0_-10px_50px_rgba(0,0,0,0.8)]">
            <div class="w-12 h-1.5 bg-gray-700 rounded-full mx-auto mb-8"></div>
            <div id="optionsList" class="flex flex-col gap-2"></div>
            <button onclick="closeOptionsModal()" class="w-full mt-6 p-4 text-gray-500 font-bold">إغلاق</button>
        </div>
    </div>

    <div id="toast" class="fixed top-10 left-1/2 -translate-x-1/2 z-[300] bg-green-500 text-black px-6 py-3 rounded-full font-bold shadow-2xl hidden opacity-0 transition-opacity duration-300 text-xs text-center"></div>

    <audio id="audioElement" class="hidden"></audio>

    <script>
        const DB_NAME = "SpotifyClone_Ultimate_V1";
        const STORES = { SONGS: "songs", PLAYLISTS: "playlists" };
        let db, allSongs = [], playlists = [], currentView = [], currentSong = null;
        let isShuffle = false, isRepeat = false, shuffleList = [];
        const audio = document.getElementById('audioElement');

        // IndexedDB Initialize
        const request = indexedDB.open(DB_NAME, 1);
        request.onupgradeneeded = (e) => {
            db = e.target.result;
            if (!db.objectStoreNames.contains(STORES.SONGS)) db.createObjectStore(STORES.SONGS, { keyPath: "id", autoIncrement: true });
            if (!db.objectStoreNames.contains(STORES.PLAYLISTS)) db.createObjectStore(STORES.PLAYLISTS, { keyPath: "id", autoIncrement: true });
        };
        request.onsuccess = (e) => { db = e.target.result; loadData(); };

        async function loadData() {
            const tx = db.transaction([STORES.SONGS, STORES.PLAYLISTS], "readonly");
            allSongs = await new Promise(r => tx.objectStore(STORES.SONGS).getAll().onsuccess = e => r(e.target.result));
            playlists = await new Promise(r => tx.objectStore(STORES.PLAYLISTS).getAll().onsuccess = e => r(e.target.result));
            renderSongs(allSongs);
            renderArtists();
            renderPlaylistsMenu();
            if (currentSong) {
                const updated = allSongs.find(s => s.id === currentSong.id);
                if (updated) currentSong = updated;
                renderLyrics();
            }
        }

        // --- UPLOAD & DUPLICATE PREVENTION ---
        async function handleUpload(event) {
            const files = event.target.files;
            if(!files.length) return;
            
            let addedCount = 0;
            let skippedCount = 0;

            for (let file of files) {
                // منع التكرار بناءً على الاسم والحجم
                if (allSongs.some(s => s.fileName === file.name && s.fileSize === file.size)) {
                    skippedCount++; continue;
                }

                const meta = await new Promise(res => {
                    jsmediatags.read(file, {
                        onSuccess: (tag) => {
                            let cover = null;
                            if (tag.tags.picture) {
                                const { data, format } = tag.tags.picture;
                                let base64 = "";
                                for (let i = 0; i < data.length; i++) base64 += String.fromCharCode(data[i]);
                                cover = `data:${format};base64,${window.btoa(base64)}`;
                            }
                            res({ 
                                title: tag.tags.title, 
                                artist: tag.tags.artist, 
                                cover, 
                                lyrics: tag.tags.lyrics?.lyrics || tag.tags.unsynchronisedLyrics?.lyrics || "" 
                            });
                        },
                        onError: () => res({})
                    });
                });

                const song = {
                    title: meta.title || file.name.split('.')[0],
                    artist: meta.artist || "فنان مجهول",
                    cover: meta.cover || "https://via.placeholder.com/300/222/555?text=No+Cover",
                    lyrics: meta.lyrics || "",
                    file,
                    fileName: file.name,
                    fileSize: file.size,
                    favorite: false,
                    dateAdded: new Date()
                };

                const tx = db.transaction(STORES.SONGS, "readwrite");
                tx.objectStore(STORES.SONGS).add(song);
                addedCount++;
            }

            loadData();
            showToast(addedCount > 0 ? `تم إضافة ${addedCount} بنجاح` : "كل الملفات مكررة بالفعل!");
        }

        // --- SMART LYRICS SYSTEM ---
        async function fetchLyricsOnline() {
            if (!currentSong) return;
            const btn = document.getElementById('searchLyricsBtn');
            const status = document.getElementById('lyricsStatus');
            btn.innerText = "جاري البحث...";
            btn.disabled = true;

            try {
                // استخدام API عام مفتوح للبحث عن الكلمات
                const response = await fetch(`https://api.lyrics.ovh/v1/${encodeURIComponent(currentSong.artist)}/${encodeURIComponent(currentSong.title)}`);
                const data = await response.json();
                
                if (data.lyrics) {
                    currentSong.lyrics = data.lyrics;
                    const tx = db.transaction(STORES.SONGS, "readwrite");
                    tx.objectStore(STORES.SONGS).put(currentSong);
                    tx.oncomplete = () => {
                        renderLyrics();
                        status.classList.remove('hidden');
                        showToast("تم العثور على الكلمات بنجاح!");
                    };
                } else {
                    showToast("لم يتم العثور على كلمات لهذه الأغنية أونلاين");
                }
            } catch (err) {
                showToast("فشل الاتصال بالإنترنت للبحث عن الكلمات");
            } finally {
                btn.innerText = "بحث أونلاين";
                btn.disabled = false;
            }
        }

        function renderLyrics() {
            const display = document.getElementById('lyricsDisplay');
            const status = document.getElementById('lyricsStatus');
            status.classList.add('hidden');

            if (!currentSong) return;
            
            if (!currentSong.lyrics) {
                display.innerHTML = `
                    <div class="text-xl text-gray-700 italic mt-20 opacity-50 text-center px-4">
                        لا توجد كلمات حالياً.<br>
                        <span class="text-sm">جرب البحث أونلاين أو الإضافة يدوياً.</span>
                    </div>`;
                return;
            }

            const lines = currentSong.lyrics.split('\n');
            display.innerHTML = lines.map(line => `
                <p class="lyric-line text-2xl lg:text-3xl font-bold mb-8 text-gray-500 hover:text-white leading-relaxed">
                    ${line.trim() || '&nbsp;'}
                </p>
            `).join('');
            display.scrollTop = 0;
        }

        function openLyricsEditor() {
            if(!currentSong) return;
            document.getElementById('lyricsModal').classList.remove('hidden');
            document.getElementById('lyricsInput').value = currentSong.lyrics || "";
        }

        function closeLyricsModal() { document.getElementById('lyricsModal').classList.add('hidden'); }

        async function saveLyrics() {
            const val = document.getElementById('lyricsInput').value;
            currentSong.lyrics = val;
            const tx = db.transaction(STORES.SONGS, "readwrite");
            tx.objectStore(STORES.SONGS).put(currentSong);
            tx.oncomplete = () => { loadData(); closeLyricsModal(); showToast("تم الحفظ يدوياً"); };
        }

        // --- UI & CORE PLAYER ---
        function showSection(name) {
            // تحديث الأزرار النشطة
            document.querySelectorAll('.nav-btn').forEach(b => b.classList.remove('active-link'));
            if(name === 'home') document.getElementById('homeNavBtn').classList.add('active-link');

            document.getElementById('home-section').classList.toggle('hidden', name !== 'home' && name !== 'favorites');
            document.getElementById('artists-section').classList.toggle('hidden', name !== 'artists');
            
            if(name === 'favorites') renderSongs(allSongs.filter(s => s.favorite), "المفضلة");
            else if(name === 'home') renderSongs(allSongs, "كل الأغاني");
        }

        function playSong(id) {
            const song = allSongs.find(s => s.id === id);
            if (!song) return;
            currentSong = song;
            audio.src = URL.createObjectURL(song.file);
            audio.play();
            updatePlayerUI(song);
            renderLyrics();
            // البحث التلقائي إذا لم تكن الكلمات موجودة
            if (!song.lyrics) {
                setTimeout(fetchLyricsOnline, 2000); 
            }
        }

        function updatePlayerUI(s) {
            document.getElementById('player-title').innerText = s.title;
            document.getElementById('player-artist').innerText = s.artist;
            document.getElementById('player-img').src = s.cover;
            document.getElementById('fullTitle').innerText = s.title;
            document.getElementById('fullArtist').innerText = s.artist;
            document.getElementById('fullCover').src = s.cover;
            document.getElementById('fullBg').style.backgroundImage = `url(${s.cover})`;
            
            const playing = !audio.paused;
            [document.getElementById('playIconMini'), document.getElementById('fullPlayIcon')].forEach(b => b.classList.toggle('hidden', playing));
            [document.getElementById('pauseIconMini'), document.getElementById('fullPauseIcon')].forEach(b => b.classList.toggle('hidden', !playing));
            updateFavoriteUI();
        }

        function togglePlay() { if(!audio.src) return; audio.paused ? audio.play() : audio.pause(); updatePlayerUI(currentSong); }

        audio.ontimeupdate = () => {
            const p = (audio.currentTime / audio.duration) * 100 || 0;
            [document.getElementById('progressBar'), document.getElementById('fullProgressBar')].forEach(b => b.value = p);
            const cur = formatTime(audio.currentTime);
            const dur = formatTime(audio.duration);
            [document.getElementById('currentTime'), document.getElementById('fullCurrentTime')].forEach(b => b.innerText = cur);
            [document.getElementById('durationTime'), document.getElementById('fullDurationTime')].forEach(b => b.innerText = dur);
        };

        function seek() { audio.currentTime = (document.getElementById('progressBar').value / 100) * audio.duration; }
        function seekFull() { audio.currentTime = (document.getElementById('fullProgressBar').value / 100) * audio.duration; }
        function formatTime(s) { if(isNaN(s)) return "0:00"; const min = Math.floor(s/60), sec = Math.floor(s%60); return `${min}:${sec < 10 ? '0' : ''}${sec}`; }

        function nextTrack() {
            const list = isShuffle ? shuffleList : currentView;
            const idx = list.findIndex(s => s.id === currentSong?.id);
            if (idx !== -1 && idx < list.length - 1) playSong(list[idx + 1].id);
            else if(isRepeat && list.length > 0) playSong(list[0].id);
        }

        function prevTrack() {
            const list = isShuffle ? shuffleList : currentView;
            const idx = list.findIndex(s => s.id === currentSong?.id);
            if (idx > 0) playSong(list[idx - 1].id);
        }

        function toggleShuffle() {
            isShuffle = !isShuffle;
            [document.getElementById('shuffleBtn'), document.getElementById('fullShuffleBtn')].forEach(b => b.classList.toggle('shuffle-active', isShuffle));
            if(isShuffle) shuffleList = [...currentView].sort(() => Math.random() - 0.5);
        }

        function toggleRepeat() { isRepeat = !isRepeat; document.getElementById('repeatBtn').classList.toggle('shuffle-active', isRepeat); }

        function showToast(msg) {
            const toast = document.getElementById('toast');
            toast.innerText = msg;
            toast.classList.remove('hidden');
            setTimeout(() => toast.classList.add('opacity-100'), 10);
            setTimeout(() => { toast.classList.remove('opacity-100'); setTimeout(() => toast.classList.add('hidden'), 300); }, 3000);
        }

        function toggleFullScreen() { if (!document.fullscreenElement) document.documentElement.requestFullscreen(); else document.exitFullscreen(); }
        function openFullPlayer() { document.getElementById('fullPlayer').classList.add('open'); }
        function closeFullPlayer() { document.getElementById('fullPlayer').classList.remove('open'); }

        function renderSongs(songs, title = "كل الأغاني") {
            currentView = songs;
            document.getElementById('mainTitle').querySelector('span').innerText = title;
            const grid = document.getElementById('songsGrid');
            if(!songs.length) { grid.innerHTML = `<div class="col-span-full py-20 text-center text-gray-600">لا توجد أغاني هنا بعد.</div>`; return; }
            grid.innerHTML = songs.map(s => `
                <div class="bg-white/5 p-4 rounded-xl group song-card cursor-pointer transition hover:bg-white/10 relative overflow-hidden">
                    <div onclick="playSong(${s.id})">
                        <img src="${s.cover}" class="w-full aspect-square object-cover rounded-lg mb-4 shadow-lg">
                        <div class="font-bold truncate text-sm mb-1">${s.title}</div>
                        <div class="text-[10px] text-gray-500 truncate">${s.artist}</div>
                    </div>
                    <button onclick="event.stopPropagation(); openSongOptionsById(${s.id})" class="absolute top-2 left-2 p-2 bg-black/50 rounded-full opacity-0 group-hover:opacity-100 transition hover:bg-green-500">
                         <svg class="h-4 w-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-width="2" d="M12 5v.01M12 12v.01M12 19v.01M12 6a1 1 0 110-2 1 1 0 010 2zm0 7a1 1 0 110-2 1 1 0 010 2zm0 7a1 1 0 110-2 1 1 0 010 2z"/></svg>
                    </button>
                    <button onclick="playSong(${s.id})" class="play-btn absolute bottom-16 left-6 bg-green-500 p-3 rounded-full text-black shadow-2xl opacity-0 translate-y-4 transition duration-300">
                        <svg class="h-5 w-5" fill="currentColor" viewBox="0 0 24 24"><path d="M8 5v14l11-7z"/></svg>
                    </button>
                </div>
            `).join('');
        }

        function openSongOptionsById(id) { const song = allSongs.find(s => s.id === id); if(song) openSongOptions(song); }

        function openSongOptions(song) {
            if(!song) return;
            const modal = document.getElementById('optionsModal');
            const list = document.getElementById('optionsList');
            modal.classList.remove('hidden');
            list.innerHTML = `
                <div class="flex items-center gap-4 p-4 border-b border-gray-800 mb-4 text-right">
                    <img src="${song.cover}" class="h-14 w-14 rounded-lg object-cover shadow-xl">
                    <div class="overflow-hidden"><div class="font-bold truncate text-lg">${song.title}</div><div class="text-xs text-gray-500">${song.artist}</div></div>
                </div>
                <button onclick="downloadSingleSongById(${song.id})" class="flex items-center gap-4 p-4 hover:bg-white/5 rounded-xl transition font-bold">تحميل بصيغة MP3</button>
                <button onclick="preparePlaylistSelection(${song.id})" class="flex items-center gap-4 p-4 hover:bg-white/5 rounded-xl transition font-bold">إضافة لقائمة تشغيل</button>
                <button onclick="toggleFavoriteById(${song.id})" class="flex items-center gap-4 p-4 hover:bg-white/5 rounded-xl transition font-bold">${song.favorite ? 'إزالة من المفضلة' : 'إضافة للمفضلة'}</button>
                <button onclick="deleteSongById(${song.id})" class="flex items-center gap-4 p-4 hover:bg-red-500/10 text-red-500 rounded-xl transition font-bold mt-2">حذف من المكتبة</button>
            `;
        }

        async function deleteSongById(id) {
            if(!confirm("حذف الأغنية نهائياً؟")) return;
            const tx = db.transaction(STORES.SONGS, "readwrite");
            tx.objectStore(STORES.SONGS).delete(id);
            tx.oncomplete = () => { closeOptionsModal(); loadData(); showToast("تم الحذف"); };
        }

        function closeOptionsModal() { document.getElementById('optionsModal').classList.add('hidden'); }

        function handleSearch() {
            const q = document.getElementById('searchInput').value.toLowerCase();
            renderSongs(allSongs.filter(s => s.title.toLowerCase().includes(q) || s.artist.toLowerCase().includes(q)), q ? `نتائج البحث عن: ${q}` : "الأغاني");
        }

        async function toggleFavoriteById(id) {
            const s = allSongs.find(x => x.id === id);
            if(s) { 
                s.favorite = !s.favorite; 
                const tx = db.transaction(STORES.SONGS, "readwrite"); 
                tx.objectStore(STORES.SONGS).put(s); 
                tx.oncomplete = () => { loadData(); updateFavoriteUI(); closeOptionsModal(); }; 
            }
        }

        function toggleCurrentFavorite() { if(currentSong) toggleFavoriteById(currentSong.id); }

        function updateFavoriteUI() {
            if(!currentSong) return;
            const fill = currentSong.favorite ? "#1db954" : "none";
            const stroke = currentSong.favorite ? "#1db954" : "currentColor";
            [document.getElementById('heartIcon'), document.getElementById('fullHeartIcon')].forEach(i => { i.setAttribute('fill', fill); i.setAttribute('stroke', stroke); });
        }

        function renderPlaylistsMenu() {
            const list = document.getElementById('playlistsList');
            list.innerHTML = playlists.map(p => `
                <div class="flex items-center justify-between group">
                    <button onclick="showPlaylist(${p.id})" class="text-sm text-gray-400 hover:text-white py-2 flex-1 text-right font-bold transition"># ${p.name}</button>
                    <button onclick="deletePlaylist(${p.id})" class="opacity-0 group-hover:opacity-100 text-red-500 px-2 transition">×</button>
                </div>
            `).join('');
        }

        function showPlaylist(id) {
            const p = playlists.find(x => x.id === id);
            renderSongs(allSongs.filter(x => p.songs.includes(x.id)), p.name);
            showSection('playlist'); 
            document.querySelectorAll('.nav-btn').forEach(b => b.classList.remove('active-link'));
        }

        async function deletePlaylist(id) {
            if(!confirm("حذف القائمة؟")) return;
            const tx = db.transaction(STORES.PLAYLISTS, "readwrite");
            tx.objectStore(STORES.PLAYLISTS).delete(id);
            tx.oncomplete = loadData;
        }

        async function addSongToPlaylist(songId, playlistId) {
            const p = playlists.find(x => x.id === playlistId);
            if(p.songs.includes(songId)) return showToast("الأغنية موجودة بالفعل");
            p.songs.push(songId);
            const tx = db.transaction(STORES.PLAYLISTS, "readwrite");
            tx.objectStore(STORES.PLAYLISTS).put(p);
            tx.oncomplete = () => { loadData(); closeOptionsModal(); showToast(`تمت الإضافة لـ ${p.name}`); };
        }

        function preparePlaylistSelection(songId) {
            const list = document.getElementById('optionsList');
            if (!playlists.length) { list.innerHTML = `<div class="p-8 text-center text-gray-500">لا توجد قوائم تشغيل.</div>`; return; }
            list.innerHTML = `<div class="p-4 font-bold text-gray-400">اختر القائمة:</div>` + 
                playlists.map(p => `<button onclick="addSongToPlaylist(${songId}, ${p.id})" class="w-full text-right p-4 hover:bg-white/5 rounded-xl mb-1 font-bold">${p.name}</button>`).join('');
        }

        function renderArtists() {
            const artists = new Map();
            allSongs.forEach(s => { s.artist.split(/[,&]|\bft\.|\bfeat\./i).forEach(name => { const n = name.trim(); if(n && !artists.has(n)) artists.set(n, s.cover); }); });
            const grid = document.getElementById('artistsGrid');
            grid.innerHTML = Array.from(artists).map(([name, cover]) => `<div onclick="filterByArtist('${name}')" class="bg-white/5 p-4 rounded-xl flex flex-col items-center hover:bg-white/10 cursor-pointer transition"><img src="${cover}" class="w-full aspect-square rounded-full mb-3 object-cover border-2 border-gray-800 shadow-xl"><div class="font-bold text-xs truncate">${name}</div></div>`).join('');
        }

        function filterByArtist(name) { renderSongs(allSongs.filter(s => s.artist.includes(name)), `أغاني ${name}`); showSection('home'); }

        function openInputModal() {
            document.getElementById('uiModal').classList.remove('hidden');
            document.getElementById('modalAction').onclick = async () => {
                const val = document.getElementById('modalInput').value; if(!val) return;
                const tx = db.transaction(STORES.PLAYLISTS, "readwrite");
                tx.objectStore(STORES.PLAYLISTS).add({ name: val, songs: [] });
                tx.oncomplete = () => { loadData(); closeUIModal(); };
            };
        }
        function closeUIModal() { document.getElementById('uiModal').classList.add('hidden'); }

        function downloadSingleSong(song) { if(!song) return; const a = document.createElement('a'); a.href = URL.createObjectURL(song.file); a.download = `${song.title}.mp3`; a.click(); }
        function downloadSingleSongById(id) { downloadSingleSong(allSongs.find(s => s.id === id)); closeOptionsModal(); }

        async function downloadAllSongs() {
            if(!allSongs.length) return showToast("المكتبة فارغة");
            showToast("جاري تحضير ملف ZIP...");
            const zip = new JSZip(); allSongs.forEach(s => zip.file(`${s.title}.mp3`, s.file));
            const content = await zip.generateAsync({type:"blob"});
            const a = document.createElement('a'); a.href = URL.createObjectURL(content); a.download = "Library.zip"; a.click();
        }

        audio.onended = nextTrack;
    </script>
</body>
</html>
